<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Snoodle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/style.css}" type="text/css">
    <link rel="icon" th:href="@{/favicon.png}" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
</head>

<body>
    <div class="header">
        <div class="container">
            <h1>
                <a href="/">
                    Snoodle
                </a>
            </h1>
            <a href="#" class="text-muted">View on GitHub</a>
        </div>
    </div>


    <div class="g-signin2" data-onsuccess="onSignIn"></div>


    <p>Google Calendar API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" style="display: none;">Authorize</button>
    <button id="signout_button" style="display: none;">Sign Out</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>


    <div class="container posts mt-0">
        <form class="form-inline" method="POST" th:action="@{/post}" th:object="${formmessage}">
            <label class="sr-only" for="eventSummary">eventSummary</label>
            <div class="input-group mb-2 mr-sm-2">
                <div class="input-group-prepend">
                    <div class="input-group-text">Event Summary</div>
                </div>
                <input type="text" class="form-control" id="eventSummary" name="eventSummary" placeholder="e.g. Hiking"
                    required>
            </div>

            <div></div>

            <label class="sr-only" for="guestList">emailList</label>
            <div class="input-group mb-2 mr-sm-2">
                <div class="input-group-prepend">
                    <div class="input-group-text">Email List (seperated by ,)</div>
                </div>
                <input type="text" class="form-control" id="emailList" name="emailList"
                    placeholder="example@email.com, example2@email.com" required>
            </div>

            <div></div>

            <label class="sr-only" for="date">date</label>
            <div class="input-group mb-2 mr-sm-2">
                <div class="input-group-prepend">
                    <div class="input-group-text">Preferred Date</div>
                </div>
                <input type="date" class="form-control" id="date" name="date" required>
            </div>

            <div></div>

            <button type="submit" class="btn btn-primary mb-2">Create Event</button>
        </form>

        <div class="alert alert-warning" role="alert" th:if="${#bools.isTrue(noBackend)}">
            Warning: Backend service is not connected. Some features of Snoodle won't work.
        </div>

        <div class="card my-3 col-12" th:each="m : ${messages}">
            <div class="card-body">
                <h5 class="card-title" th:text="${m.eventSummary}">Event Name</h5>
                <h6 class="card-subtitle mb-2 text-muted"
                    th:text="${T(cloudcode.guestbook.frontend.PrintDuration).print(m.createDate)}">Create Date</h6>
                <br>
                <p class="card-text" th:text="${m.emailList}">Email List</p>
            </div>
        </div>
        <div class="alert alert-info" role="alert" th:if="${#lists.isEmpty(messages)}">
            No events entered yet :).
        </div>
    </div>

    <script type="text/javascript">
        // Client ID and API key from the Developer Console
        var CLIENT_ID = '<YOUR_CLIENT_ID>';
        var API_KEY = '<YOUR_API_KEY>';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/calendar";

        var authorizeButton = document.getElementById('authorize_button');
        var signoutButton = document.getElementById('signout_button');

        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        function initClient() {
            gapi.client.init({
                apiKey: 'AIzaSyAgmsmNX639vCXiCWixgSiUJe-RqqxzXHc',
                clientId: '247759510410-9rv5nhjobsokna5dnibh2815vcsa9mc1.apps.googleusercontent.com',
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
            }, function (error) {
                appendPre(JSON.stringify(error, null, 2));
            });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                listUpcomingEvents();
            } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
            }
        }

        /**
         *  Sign in the user upon button click.
         */
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */
        function appendPre(message) {
            var pre = document.getElementById('content');
            var textContent = document.createTextNode(message + '\n');
            pre.appendChild(textContent);
        }

        /**
         * Print the summary and start datetime/date of the next ten events in
         * the authorized user's calendar. If no events are found an
         * appropriate message is printed.
         */
        function listUpcomingEvents() {
            gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 10,
                'orderBy': 'startTime'
            }).then(function (response) {
                var events = response.result.items;
                appendPre('Upcoming events:');

                if (events.length > 0) {
                    for (i = 0; i < events.length; i++) {
                        var event = events[i];
                        var when = event.start.dateTime;
                        if (!when) {
                            when = event.start.date;
                        }
                        appendPre(event.summary + ' (' + when + ')')
                    }
                } else {
                    appendPre('No upcoming events found.');
                }
            });
        }



        function sendSampleRequest(projectId = 'YOUR_PROJECT_ID') {
            var user = gapi.auth2.getAuthInstance().currentUser.get();
            var idToken = user.getAuthResponse().id_token;
            var endpoint = 'http://localhost/Snoodle/saveEvent';
            var xhr = new XMLHttpRequest();
            xhr.open('GET', endpoint + '?access_token=' + encodeURIComponent(idToken));
            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    window.alert(xhr.responseText);
                }
            };
            xhr.send();
        }

    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>
</body>

</html>